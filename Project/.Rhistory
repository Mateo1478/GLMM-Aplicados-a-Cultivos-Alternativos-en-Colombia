theme_minimal(base_size = 8) +
theme(
legend.position = "none",
strip.text = element_text(face = "bold")
)
if (!dir.exists("results/figs")) dir.create("results/figs", recursive = TRUE)
ggsave(
filename = "results/figs/produccion_anual_top20_municipios.png",
plot = g_mpios_top20,
width = 14,
height = 10,
dpi = 300
)
print(g_mpios_top20)
top20_mpios <- base_filtrada %>%
group_by(municipio) %>%
summarise(produccion_total = sum(produccion, na.rm = TRUE), .groups = "drop") %>%
arrange(desc(produccion_total)) %>%
slice_head(n = 20) %>%
pull(municipio)
prod_mpio_anual_top20 <- base_filtrada %>%
filter(municipio %in% top20_mpios) %>%
group_by(ano, municipio) %>%
summarise(produccion_total = sum(produccion, na.rm = TRUE), .groups = "drop")
g_mpios_top20 <- ggplot(
prod_mpio_anual_top20,
aes(x = ano, y = produccion_total, group = municipio)
) +
geom_line(alpha = 0.8) +
facet_wrap(~ municipio, scales = "free_y") +
labs(
title = "Producción total anual - Top 20 municipios",
subtitle = "Municipios con mayor producción acumulada en el período",
x = "Año",
y = "Producción (toneladas)"
) +
theme_minimal(base_size = 8) +
theme(
legend.position = "none",
strip.text = element_text(face = "bold")
)
if (!dir.exists("/figs")) dir.create("/figs", recursive = TRUE)
ggsave(
filename = "figs/produccion_anual_top20_municipios.png",
plot = g_mpios_top20,
width = 14,
height = 10,
dpi = 300
)
print(g_mpios_top20)
# Partimos de base_filtrada (la de deptos >1%)
base_sin_inf <- base_filtrada %>%
# quitar casos donde producción > 0 y área cosechada = 0
filter(!(produccion > 0 & area_cosechada == 0)) %>%
# recalcular rendimiento por si acaso
mutate(
rendimiento = if_else(
area_cosechada > 0,
produccion / area_cosechada,
NA_real_
)
)
rend_con_flag <- base_sin_inf %>%
group_by(cultivo) %>%
mutate(
Q1  = quantile(rendimiento, 0.25, na.rm = TRUE),
Q3  = quantile(rendimiento, 0.75, na.rm = TRUE),
IQR = Q3 - Q1,
lim_inf  = Q1 - 1.5 * IQR,
lim_sup  = Q3 + 1.5 * IQR,
absurdo  = rendimiento < lim_inf | rendimiento > lim_sup
) %>%
ungroup()
rend_absurdos <- rend_con_flag %>%
filter(absurdo == TRUE, !is.na(rendimiento)) %>%
arrange(desc(rendimiento))  # o como quieras
# Partimos de base_filtrada (la de deptos >1%)
base_sin_inf <- base_filtrada %>%
# quitar casos donde producción > 0 y área cosechada = 0
filter(!(produccion > 0 & area_cosechada == 0)) %>%
# recalcular rendimiento por si acaso
mutate(
rendimiento = if_else(
area_cosechada > 0,
produccion / area_cosechada,
NA_real_
)
)
rend_con_flag <- base_sin_inf %>%
group_by(cultivo) %>%
mutate(
Q1  = quantile(rendimiento, 0.25, na.rm = TRUE),
Q3  = quantile(rendimiento, 0.75, na.rm = TRUE),
IQR = Q3 - Q1,
lim_inf  = Q1 - 1.5 * IQR,
lim_sup  = Q3 + 1.5 * IQR,
absurdo  = rendimiento < lim_inf | rendimiento > lim_sup
) %>%
ungroup()
rend_absurdos <- rend_con_flag %>%
filter(absurdo == TRUE, !is.na(rendimiento)) %>%
arrange(desc(rendimiento))
head(rend_absurdos)
# 1) Filtrar y preparar los datos para el GLMM
datos_glmm <- cultivos_rendimiento1 %>%
# Nos quedamos solo con filas donde todo lo que entra al modelo está definido
filter(
!is.na(supero_rendimiento),
!is.na(ALT),
!is.na(TEMP_MED),
!is.na(rendimiento_anterior),
!is.na(ano),
is.finite(ALT),
is.finite(TEMP_MED),
is.finite(rendimiento_anterior)
) %>%
mutate(
supero_rendimiento = as.integer(supero_rendimiento),  # 0/1
ano       = factor(ano),
cultivo   = factor(cultivo),
municipio = factor(municipio)
)
save(list = "datos_glmm", file = "dataglmm/datos_glmm.RData")
knitr::opts_chunk$set(echo = TRUE)
# ================================
# Cargar objeto desde .RData
# ================================
load("dataglmm/datos_glmm.RData")
str(datos_glmm)
# ================================
# Cargar objeto desde .RData
# ================================
load("dataglmm/datos_glmm.RData")
glimpse(datos_glmm)
library(dplyr)
library(tibble)
# ================================
# Cargar objeto desde .RData
# ================================
load("dataglmm/datos_glmm.RData")
glimpse(datos_glmm)
datosglm_palma <- datos_glmm %>% filter(cultivo=="PALMA DE ACEITE")
modelo_glmm <- glmer(
supero_rendimiento ~ ALT + TEMP_MED + produccion + as.numeric(ano) + (1+as.numeric(ano)|municipio),
data   = datosglm_palma,
family = binomial(link = "logit"),
control = glmerControl(optimizer = "bobyqa",
optCtrl = list(maxfun = 2e5))
)
summary(modelo_glmm)
datos_glmm  %>% filter(cultivo=="PALMA DE ACEITE") %>% ggplot(aes(x=as.numeric(ano), y = rendimiento,colour = municipio))+ geom_line(show.legend = FALSE)
#IDENTIFICAR MUNICIPIOS CON RENDIMIENTO ABSURDO
datosglm_cafe <- datos_glmm %>% filter(rendimiento>1.116,cultivo=="CAFE")
#I(ALT/1000) + TEMP_MED + I(produccion/1000)
modelo_binario2 <- glmer(
supero_rendimiento ~ I(ALT/1000) + TEMP_MED + I(produccion/1000) +
I(as.numeric(as.character(datosglm_cafe$ano))/1000) +
(1 + I(as.numeric(as.character(datosglm_cafe$ano))/1000) | municipio) ,
data = datosglm_cafe,
family = binomial(link = "logit"),
control = glmerControl(optimizer = "bobyqa")
)
summary(modelo_binario2)
datosglm_cafe$ano_num <- as.numeric(as.character(datosglm_cafe$ano))
datosglm_cafe$ano_c <- scale(datosglm_cafe$ano_num, center = TRUE, scale = FALSE)
modelo_binario2 <- glmer(
supero_rendimiento ~ I(ALT/1000) + TEMP_MED + I(produccion/1000) +
ano_c +
(1 + ano_c | municipio),
data = datosglm_cafe,
family = binomial(link = "logit"),
control = glmerControl(optimizer = "bobyqa")
)
summary(modelo_binario2)
Detecoca <- read.csv(
"Detección_de_Cultivos_de_Coca.csv",
fileEncoding = "UTF-8",
stringsAsFactors = FALSE
)
glimpse(Detecoca)
coca_raw <- Detecoca
year_cols <- names(coca_raw)[str_detect(names(coca_raw), "^X\\d{4}$")]
parse_ha <- function(x) {
x <- str_trim(as.character(x))
x <- str_replace_all(x, "^-\\s*0$|^-$|^\\-\\s*0(\\,0+|\\.0+)?$", "0")
x <- str_replace_all(x, "\\s+", "")
# Caso con punto de miles y coma decimal: 1.088,9 -> 1088.9
x <- ifelse(str_detect(x, "^\\d{1,3}(\\.\\d{3})+,\\d+$"),
str_replace_all(x, "\\.", "") |> str_replace(",", "."),
x)
# Caso con coma de miles y punto decimal: 1,056.0 -> 1056.0
x <- ifelse(str_detect(x, "^\\d{1,3}(,\\d{3})+\\.\\d+$"),
str_replace_all(x, ",", ""),
x)
# Caso con coma decimal simple: 61,5 -> 61.5
x <- ifelse(str_detect(x, "^\\d+,\\d+$"),
str_replace(x, ",", "."),
x)
suppressWarnings(as.numeric(x))
}
coca_long <- coca_raw %>%
mutate(
CODDEPTO = as.integer(CODDEPTO),
CODMPIO  = as.integer(CODMPIO),
DEPARTAMENTO = as.character(DEPARTAMENTO),
MUNICIPIO    = as.character(MUNICIPIO)
) %>%
pivot_longer(
cols = all_of(year_cols),
names_to = "ano",
values_to = "ha_raw"
) %>%
mutate(
ano = as.integer(str_remove(ano, "^X")),
ha  = parse_ha(ha_raw)
) %>%
select(CODDEPTO, DEPARTAMENTO, CODMPIO, MUNICIPIO, ano, ha)
# 4) Chequeos rápidos
glimpse(coca_long)
top_mpios <- coca_long %>%
group_by(CODMPIO, DEPARTAMENTO, MUNICIPIO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
top_mpios
write_xlsx(
top_mpios,
path = "ha_por_municipio.xlsx"
)
top_dptos <- coca_long %>%
group_by(DEPARTAMENTO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
top_dptos
write_xlsx(
top_dptos,
path = "ha_por_departamento.xlsx"
)
coca_mpio <- coca_long %>%
group_by(CODMPIO, DEPARTAMENTO, MUNICIPIO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
)
coca_mpio <- coca_mpio %>%
mutate(
CODMPIO = as.character(CODMPIO),
CODMPIO = stringr::str_pad(CODMPIO, width = 5, pad = "0")
)
# Ordenar de mayor a menor y ver los primeros 25
top_25 <- coca_mpio %>%
arrange(desc(ha_total)) %>%
slice_head(n = 25)
top_25
top_mpios <- coca_long %>%
group_by(CODMPIO, DEPARTAMENTO, MUNICIPIO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
write_xlsx(
top_mpios,
path = "ha_por_municipio.xlsx"
)
top_dptos <- coca_long %>%
group_by(DEPARTAMENTO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
top_dptos
write_xlsx(
top_dptos,
path = "ha_por_departamento.xlsx"
)
if (!dir.exists("tablas")) dir.create("tablas")
openxlsx::write.xlsx(
top_mpios,
file = "tablas/ha_coca_total_por_municipio.xlsx",
rowNames = FALSE
)
openxlsx::write.xlsx(
top_dptos,
file = "tablas/ha_coca_total_por_departamento.xlsx",
rowNames = FALSE
)
top_mpios <- coca_long %>%
group_by(CODMPIO, DEPARTAMENTO, MUNICIPIO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
top_dptos <- coca_long %>%
group_by(DEPARTAMENTO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(ha_total))
if (!dir.exists("tablas")) dir.create("tablas")
openxlsx::write.xlsx(
top_mpios,
file = "tablas/ha_coca_total_por_municipio.xlsx",
rowNames = FALSE
)
openxlsx::write.xlsx(
top_dptos,
file = "tablas/ha_coca_total_por_departamento.xlsx",
rowNames = FALSE
)
coca_mpio <- coca_long %>%
group_by(CODMPIO, DEPARTAMENTO, MUNICIPIO) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
)
coca_mpio <- coca_mpio %>%
mutate(
CODMPIO = as.character(CODMPIO),
CODMPIO = stringr::str_pad(CODMPIO, width = 5, pad = "0")
)
top_25 <- coca_mpio %>%
arrange(desc(ha_total)) %>%
slice_head(n = 25)
if (!dir.exists("tablas")) dir.create("tablas")
openxlsx::write.xlsx(
top_25,
file = "tablas/ha_total_por_municipio_departamento.xlsx",
rowNames = FALSE
)
municipios_mapa <- municipios_mapa %>%
mutate(
codigo_mpio = paste0(
stringr::str_pad(DPTO_CCDGO, width = 2, pad = "0"),
stringr::str_pad(MPIO_CCDGO, width = 3, pad = "0")
)
)
mapa_coca_mpio <- municipios_mapa %>%
left_join(
coca_mpio,
by = c("codigo_mpio" = "CODMPIO")
)
municipios_mapa <- municipios_mapa %>%
mutate(
codigo_mpio = paste0(
stringr::str_pad(DPTO_CCDGO, width = 2, pad = "0"),
stringr::str_pad(MPIO_CCDGO, width = 3, pad = "0")
)
)
mapa_coca_mpio <- municipios_mapa %>%
left_join(
coca_mpio,
by = c("codigo_mpio" = "CODMPIO")
)
ggplot(mapa_coca_mpio) +
geom_sf(aes(fill = ha_total), color = NA) +
scale_fill_gradientn(
colours = c("#e5f5e0", "#a1d99b", "#31a354", "#006d2c", "#002b13"),
na.value = "grey90",
trans = "sqrt",
labels = comma
) +
labs(
title = "Distribución espacial de cultivos de coca en Colombia",
subtitle = "Hectáreas acumuladas por municipio",
fill = "ha de coca"
) +
theme_minimal() +
theme(
axis.text = element_blank(),
axis.title = element_blank(),
panel.grid = element_blank()
)
lab_k <- function(x) paste0(round(x/1000, 1), " k")
coca_anual <- coca_long %>%
group_by(ano) %>% summarise(ha_total = sum(ha, na.rm = TRUE), .groups = "drop") %>% arrange(ano)
write_xlsx(coca_anual, "serie_coca_por_ano.xlsx")
p <- ggplot(coca_anual, aes(ano, ha_total)) +
geom_line(color = "#238b45", linewidth = 1.2) +
geom_point(color = "#006d2c", size = 2.5) +
geom_text(aes(label = lab_k(ha_total)), vjust = -0.6, size = 3, color = "#00441b") +
scale_y_continuous(labels = lab_k) + scale_x_continuous(breaks = pretty_breaks()) +
labs(title = "Serie de tiempo de cultivos de coca detectados en Colombia",
subtitle = "Hectáreas totales por año", x = "Año", y = "Hectáreas (k)") +
theme_minimal() + theme(panel.grid.minor = element_blank(), plot.title = element_text(face = "bold"))
p
ggsave("serie_coca_por_ano.png", p, width = 11, height = 5, dpi = 300)
lab_k <- function(x) paste0(round(x/1000, 1), " k")
coca_anual <- coca_long %>%
group_by(ano) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(ano)
if (!dir.exists("tables")) dir.create("tables")
if (!dir.exists("figs")) dir.create("figs")
write_xlsx(
coca_anual,
path = "tables/serie_coca_por_ano.xlsx"
)
p <- ggplot(coca_anual, aes(ano, ha_total)) +
geom_line(color = "#238b45", linewidth = 1.2) +
geom_point(color = "#006d2c", size = 2.5) +
geom_text(aes(label = lab_k(ha_total)), vjust = -0.6, size = 3, color = "#00441b") +
scale_y_continuous(labels = lab_k) +
scale_x_continuous(breaks = pretty_breaks()) +
labs(
title = "Serie de tiempo de cultivos de coca detectados en Colombia",
subtitle = "Hectáreas totales por año",
x = "Año",
y = "Hectáreas (k)"
) +
theme_minimal() +
theme(
panel.grid.minor = element_blank(),
plot.title = element_text(face = "bold")
)
ggsave(
filename = "figs/serie_coca_por_ano.png",
plot = p,
width = 11,
height = 5,
dpi = 300
)
p
lab_k <- function(x) paste0(round(x/1000, 1), "k")
coca_anual <- coca_long %>%
group_by(ano) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(ano)
if (!dir.exists("tables")) dir.create("tables")
if (!dir.exists("figs")) dir.create("figs")
write_xlsx(
coca_anual,
path = "tables/serie_coca_por_ano.xlsx"
)
p <- ggplot(coca_anual, aes(ano, ha_total)) +
geom_line(color = "#238b45", linewidth = 1.2) +
geom_point(color = "#006d2c", size = 2.5) +
geom_text(aes(label = lab_k(ha_total)), vjust = -0.6, size = 3, color = "#00441b") +
scale_y_continuous(labels = lab_k) +
scale_x_continuous(breaks = pretty_breaks()) +
labs(
title = "Serie de tiempo de cultivos de coca detectados en Colombia",
subtitle = "Hectáreas totales por año",
x = "Año",
y = "Hectáreas (k)"
) +
theme_minimal() +
theme(
panel.grid.minor = element_blank(),
plot.title = element_text(face = "bold")
)
ggsave(
filename = "figs/serie_coca_por_ano.png",
plot = p,
width = 11,
height = 5,
dpi = 300
)
p
lab_k <- function(x) paste0(round(x/1000, 1), "k")
coca_anual <- coca_long %>%
group_by(ano) %>%
summarise(
ha_total = sum(ha, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(ano)
if (!dir.exists("tables")) dir.create("tables")
if (!dir.exists("figs")) dir.create("figs")
write_xlsx(
coca_anual,
path = "tablas/serie_coca_por_ano.xlsx"
)
p <- ggplot(coca_anual, aes(ano, ha_total)) +
geom_line(color = "#238b45", linewidth = 1.2) +
geom_point(color = "#006d2c", size = 2.5) +
geom_text(aes(label = lab_k(ha_total)), vjust = -0.6, size = 3, color = "#00441b") +
scale_y_continuous(labels = lab_k) +
scale_x_continuous(breaks = pretty_breaks()) +
labs(
title = "Serie de tiempo de cultivos de coca detectados en Colombia",
subtitle = "Hectáreas totales por año",
x = "Año",
y = "Hectáreas (k)"
) +
theme_minimal() +
theme(
panel.grid.minor = element_blank(),
plot.title = element_text(face = "bold")
)
ggsave(
filename = "figs/serie_coca_por_ano.png",
plot = p,
width = 11,
height = 5,
dpi = 300
)
p
